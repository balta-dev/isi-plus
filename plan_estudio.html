<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plan de Estudio</title>
</head>
<body>
  <div id="app">
    <p>Porcentaje aprobado de la carreta: {{ porcentajeCarrera }}%</p>
    <h2>Primer año</h2>
    <h3>Anual</h3>
    <materia v-for="m in this.$store.getters.getMateriasAnoAnuales('1')"
             :key="m.id"
             :id="m.id"
             :nombre="m.nombre"
             :integradora="m.integradora"
             :electiva="m.electiva">
    </materia>
    <h3>Primer cuatrimestre</h3>    
    <materia v-for="m in this.$store.getters.getMateriasAnoCuatrimestre('1', '1')"
             :key="m.id"
             :id="m.id"
             :nombre="m.nombre"
             :integradora="m.integradora"
             :electiva="m.electiva">
    </materia>
    <h3>Segundo cuatrimestre</h3>
    <materia v-for="m in this.$store.getters.getMateriasAnoCuatrimestre('1', '2')"
             :key="m.id"
             :id="m.id"
             :nombre="m.nombre"
             :integradora="m.integradora"
             :electiva="m.electiva">
    </materia>
  </div>

  <script src="https://unpkg.com/vue@2.2.6/dist/vue.js"></script>
  <script src="https://unpkg.com/vuex@2.3.0"></script>  
  <script>
    const store = new Vuex.Store({
      state: {
        materias: [
          // Primer año
          { id: '1', nombre: 'Análisis Matemático I',             ano: '1', cuatrimestre: '2', esAnual: false, estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '2', nombre: 'Sistemas y Organizaciones',         ano: '1', cuatrimestre: '0', esAnual: true,  estado: 'desaprobada', integradora: true,  electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '3', nombre: 'Álgebra y Geometría Analítica',     ano: '1', cuatrimestre: '1', esAnual: false, estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '4', nombre: 'Matemática Discreta',               ano: '1', cuatrimestre: '1', esAnual: false, estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '5', nombre: 'Química',                           ano: '1', cuatrimestre: '1', esAnual: false, estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '6', nombre: 'Sistemas de Representación',        ano: '1', cuatrimestre: '1', esAnual: false, estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '7', nombre: 'Algoritmos y Estructuras de Datos', ano: '1', cuatrimestre: '2', esAnual: false, estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '8', nombre: 'Arquitectura de Computadoras',      ano: '1', cuatrimestre: '2', esAnual: false, estado: 'desaprobada', integradora: false, electiva: true,  cursar: { regular: [], aprobada: []}, aprobar: [] },
          { id: '9', nombre: 'Análisis Matemático II',            ano: '2', cuatrimestre: '0', esAnual: true,  estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: ['1', '3'], aprobada: []}, aprobar: ['1', '3'] },
          { id: '21', nombre: 'Matemática Superior',              ano: '3', cuatrimestre: '0', esAnual: true,  estado: 'desaprobada', integradora: false, electiva: false, cursar: { regular: ['9'], aprobada: ['1', '3']}, aprobar: ['9'] },
        ]
      },
      getters: {
        getMaterias: state => {
          return state.materias;
        },
        getMateriaById: (state, getters) => (id) => {
          return state.materias.find(materia => materia.id === id)
        },
        getMateriasAprobadas: state => {
          return state.materias.filter(materia => materia.estado === 'aprobada');
        },
        getMateriasRegulares: state => {
          return state.materias.filter(materia => materia.estado === 'regular');
        },
        getMateriasAnoAnuales: (state, getters) => (ano) => {
          return state.materias.filter(materia => materia.ano === ano && materia.esAnual)
        },
        getMateriasAnoCuatrimestre: (state, getters) => (ano, cuatrimestre) => {
          return state.materias.filter(materia => materia.ano === ano && materia.cuatrimestre === cuatrimestre)
        },
        getCantidadMaterias: state => {
          return state.materias.length;
        },
        getCantidadMateriasAprobadas: (state, getters) => {
          return getters.getMateriasAprobadas.length;
        }
      },
      mutations: {
        cambiarEstadoMateria (state, payload) {
          state.materias.find(materia => materia.id === payload.id).estado = payload.estado;
        }
      }
    });

    const Materia = {
      props: ['id', 'nombre', 'integradora', 'electiva'],
      template: '\
        <div>\
          <div>{{ nombre }}<em v-if="integradora"> (Integradora)</em><em v-if="electiva"> (Electiva)</em></div>\
          <input type="radio" :name="[`m-${ id }`]" v-model="estado" :disabled="!seCursa" value="desaprobada">Desaprobada<br>\
          <input type="radio" :name="[`m-${ id }`]" v-model="estado" :disabled="!seCursa" value="regular">Regular<br>\
          <input type="radio" :name="[`m-${ id }`]" v-model="estado" :disabled="!seCursa || !seAprueba" value="aprobada">Aprobada<br><br>\
        </div>',
      computed: {
        estado: {
          get: function () {
            return this.$store.getters.getMateriaById(this.id).estado;
          },
          set: function (valor) {
            store.commit('cambiarEstadoMateria', {
              id: this.id,
              estado: valor
            });
          }
        },
        seCursa: {
          get: function () {            
            const materia = this.$store.getters.getMateriaById(this.id);
            const necesitaRegulares = materia.cursar.regular;
            const necesitaAprobadas = materia.cursar.aprobada;
            const estanRegulares = this.$store.getters.getMateriasRegulares.map(m => m.id);
            const estanAprobadas = this.$store.getters.getMateriasAprobadas.map(m => m.id);
            const regularesYAprobadas = estanRegulares.concat(estanAprobadas);

            function arrayContainsArray (superset, subset) {
              return subset.every(function (value) {
                return (superset.indexOf(value) >= 0);
              });
            }

            const sePuedeCursar = arrayContainsArray(regularesYAprobadas, necesitaRegulares)
                && arrayContainsArray(estanAprobadas, necesitaAprobadas);

            if (!sePuedeCursar)
              store.commit('cambiarEstadoMateria', {
                id: materia.id,
                estado: 'desaprobada'
              });

            return sePuedeCursar;
          }
        },
        seAprueba: {
          get: function () {            
            const materia = this.$store.getters.getMateriaById(this.id);
            const necesitaAprobadas = materia.aprobar;
            const estanAprobadas = this.$store.getters.getMateriasAprobadas.map(m => m.id);

            function arrayContainsArray (superset, subset) {
              return subset.every(function (value) {
                return (superset.indexOf(value) >= 0);
              });
            }

            const sePuedeAprobar = arrayContainsArray(estanAprobadas, necesitaAprobadas);

            if (!sePuedeAprobar && this.estado != 'regular')
              store.commit('cambiarEstadoMateria', {
                id: materia.id,
                estado: 'desaprobada'
              });

            return sePuedeAprobar;
          }
        }
      },
      methods: {

      }
    };

    const app = new Vue({
      el: '#app',
      store,
      components: { Materia },
      computed: {
        porcentajeCarrera: function () {
          return this.$store.getters.getCantidadMateriasAprobadas / this.$store.getters.getCantidadMaterias * 100;
        }
      }
    });
  </script>
</body>
</html>